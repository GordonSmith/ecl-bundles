<!DOCTYPE html>
<html>
<head>
    <title>HPCC:  Visualization</title>

    <script src="../Visualization/node_modules/requirejs/require.js"></script>
    <script src="../Visualization/src/loader.js"></script>
    <!--
    <script src="http://viz.hpccsystems.com/v1.14.0-rc10/dist-amd/hpcc-viz.js"></script>
    -->
    <!--
    <script src="../Visualization/node_modules/requirejs/require.js"></script>
    <script src="../Visualization/src/loader.js"></script>
    -->
    <style>
        body {
            margin: 0px;
            overflow: hidden;
        }

        #placeholder {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body onresize="doResize();">
    <div id="placeholder">
    </div>
    <script>
        var grid;
        require(["src/composite/Dermatology", "src/other/Comms", "src/other/Persist", "src/common/Utility"], function (Dermatology, Comms, Persist, Utility) {
            var dermatology = new Dermatology()
                .target("placeholder")
                .render(function (w) {
                    grid = w;
                })
            ;

            var espUrl = window.location.href;
            switch (window.location.hostname) {
                //  Used for debugging JS
                case "localhost":
                    espUrl = "http://192.168.3.22:8010/WsWorkunits/res/W20160814-073300/res/index.html";
                    break;
            }
            var espConnection = Comms.createESPConnection(espUrl);

            var toggleProperties = dermatology.toggleProperties;
            dermatology.toggleProperties = function () {
                toggleProperties.apply(dermatology, arguments);
                if (!dermatology._showProperties) {
                    var persistStr = Persist.serialize(dermatology.widget());
                    espConnection.appData("HPCC-VizBundle", "persist", persistStr);
                }
            };

            var persistPromise = espConnection.appData("HPCC-VizBundle", "persist").then(function (persistStr) {
                return Persist.create(persistStr);
            });
            var metaPromise = espConnection.result("__hpcc_visualization").then(function (response) {
                if (response && response.length) {
                    var meta = response[0];
                    var retVal = {
                        classID: meta.classid
                    };
                    retVal.mappings = {};
                    for (var key in meta.mappings) {
                        retVal.mappings[key] = meta.mappings[key].toLowerCase()
                    }
                    retVal.data = meta.data.map(function (row) {
                        return [row[retVal.mappings.label], +row[retVal.mappings.weight]];
                    })
                    return retVal;
                }
                return null;
            });
            Promise.all([persistPromise, metaPromise]).then(function (promises) {
                var widget = promises[0];
                var meta = promises[1];
                if (widget) {
                    dermatology
                        .widget(widget
                            .columns([meta.mappings.label, meta.mappings.weight])
                            .data(meta.data))
                        .render()
                    ;
                } else if (meta) {
                    Utility.requireWidget(meta.classid).then(function (Widget) {
                        dermatology
                            .widget(new Widget()
                                .columns([meta.mappings.label, meta.mappings.weight])
                                .data(meta.data))
                            .render()
                        ;
                    });
                } else {
                    console.log("no visualization info found");
                }
            });
        });

        function doResize() {
            if (grid) {
                grid
                    .resize()
                    .lazyRender()
                ;
            }
        };
    </script>
</body>
</html>
